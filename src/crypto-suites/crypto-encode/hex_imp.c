/*
 * Copyright 2020-2022 Safeheron Inc. All Rights Reserved.
 *
 * Licensed under the Apache License 2.0 (the "License").  You may not use
 * this file except in compliance with the License.  You can obtain a copy
 * in the file LICENSE in the source distribution or at
 * https://www.safeheron.com/opensource/license.html
 */

#include "hex_imp.h"
#include <string.h>

// tallymarker_hextobin
int tallymarker_hex2bin(const char *str, uint8_t *bytes, size_t blen) {
    size_t pos;
    uint8_t idx0;
    uint8_t idx1;

    // mapping of ASCII characters to hex values
    const uint8_t hashmap[] =
            {
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  !"#$%&'
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ()*+,-./
                    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, // 01234567
                    0x08, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 89:;<=>?
                    0x00, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x00, // @ABCDEFG
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // HIJKLMNO
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // PQRSTUVW
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // XYZ[\]^_
                    0x00, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x00, // `abcdefg
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // hijklmno
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // pqrstuvw
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // xyz{|}~.
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // ........
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00  // ........
            };

    memset(bytes, 0, blen);
    size_t len = strlen(str);
    for (pos = 0; ((pos < (blen * 2)) && (pos < len)); pos += 2) {
        idx0 = (uint8_t) str[pos + 0];
        idx1 = (uint8_t) str[pos + 1];
        bytes[pos / 2] = (uint8_t)(hashmap[idx0] << 4) | hashmap[idx1];
    };

    return 1;
}

int tallymarker_bin2hex(const uint8_t *bytes, size_t blen, char *str, size_t slen) {
    char ch[17] = "0123456789abcdef";
    for (size_t i = 0; (i < blen) && (i * 2 + 1 < slen); ++i) {
        int low = bytes[i] & 0x0F;
        int high = (bytes[i] >> 4) & 0x0F;
        str[i * 2] = ch[high];
        str[i * 2 + 1] = ch[low];
    }
    return 1;
}

